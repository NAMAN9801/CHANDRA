<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project Chandra | Upload & Analyze</title>
  <style>
    :root {
      --bg: #0b1020;
      --surface: #121a31;
      --surface-2: #1b2647;
      --text: #edf2ff;
      --muted: #b9c4ea;
      --accent: #4e7cff;
      --success: #2ea043;
      --error: #d73a49;
      --border: #2d3c6a;
      --focus: #8fb2ff;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: Inter, Arial, Helvetica, sans-serif;
      color: var(--text);
      background: radial-gradient(circle at top, #1b2950 0, var(--bg) 50%);
      display: grid;
      place-items: center;
      padding: 1rem;
    }

    main {
      width: min(980px, 100%);
      background: color-mix(in oklab, var(--surface), #000 10%);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.25rem;
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.45);
    }

    h1 {
      margin: 0 0 0.25rem;
      font-size: clamp(1.4rem, 2.2vw, 2rem);
    }

    .lede {
      margin: 0 0 1rem;
      color: var(--muted);
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .panel {
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    input[type="file"] {
      width: 100%;
      color: var(--text);
      padding: 0.5rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #0f1730;
    }

    .actions {
      margin-top: 0.85rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    button {
      border: 0;
      border-radius: 10px;
      padding: 0.65rem 1rem;
      font-weight: 700;
      cursor: pointer;
      color: white;
      background: var(--accent);
    }

    button[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }

    button.secondary {
      background: #334671;
    }

    button:focus-visible,
    input:focus-visible {
      outline: 3px solid var(--focus);
      outline-offset: 2px;
    }

    .state {
      margin-top: 0.85rem;
      border-radius: 8px;
      padding: 0.7rem;
      font-weight: 600;
      background: #192542;
      border: 1px solid #2f487b;
    }

    .state.success {
      border-color: #3e8a54;
      background: #1e3d28;
    }

    .state.error {
      border-color: #8d4452;
      background: #3c1f26;
    }

    .muted {
      color: var(--muted);
      font-size: 0.95rem;
      margin-top: 0.5rem;
    }

    .preview {
      width: 100%;
      min-height: 200px;
      max-height: 50vh;
      object-fit: contain;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #0f1730;
    }

    .output {
      white-space: pre-wrap;
      margin: 0;
      line-height: 1.35;
      color: #eaf0ff;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 0.9rem;
      background: #0d152d;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0.75rem;
      max-height: 36vh;
      overflow: auto;
    }

    dl {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 0.3rem 0.8rem;
      margin: 0;
    }

    dt {
      color: var(--muted);
      font-weight: 600;
    }

    dd {
      margin: 0;
    }

    @media (min-width: 860px) {
      .grid {
        grid-template-columns: minmax(340px, 1fr) minmax(320px, 1fr);
      }
    }
  </style>
</head>
<body>
  <main>
    <h1>Project Chandra Image Analyzer</h1>
    <p class="lede">Upload an image, preview it, then run backend analysis in one flow.</p>

    <div class="grid">
      <section class="panel" aria-labelledby="uploadHeading">
        <h2 id="uploadHeading">1) Select and Upload</h2>
        <form id="uploadForm" novalidate>
          <label for="imageInput">Image file (PNG, JPG, JPEG, WEBP up to 10MB)</label>
          <input id="imageInput" name="image" type="file" accept="image/png,image/jpeg,image/webp" required>
          <p id="validationHelp" class="muted">Tip: press Enter on this file picker, then choose your image.</p>
          <div class="actions">
            <button id="uploadBtn" type="submit">Upload image</button>
            <button id="analyzeBtn" class="secondary" type="button" disabled>Analyze uploaded image</button>
          </div>
        </form>
        <div id="status" class="state" role="status" aria-live="polite">State: idle</div>
        <p class="muted" id="errorText" hidden></p>
      </section>

      <section class="panel" aria-labelledby="previewHeading">
        <h2 id="previewHeading">2) Preview and Results</h2>
        <img id="preview" class="preview" alt="No uploaded image yet." src="" hidden>
        <p id="noPreview" class="muted">No image uploaded yet.</p>

        <h3>Metrics</h3>
        <dl>
          <dt>Upload time</dt><dd id="uploadTime">—</dd>
          <dt>Analysis time</dt><dd id="analysisTime">—</dd>
          <dt>Total time</dt><dd id="totalTime">—</dd>
          <dt>Image URL</dt><dd id="displayUrl">—</dd>
        </dl>

        <h3>Analysis Result</h3>
        <pre id="analysisOutput" class="output" aria-live="polite">No analysis yet.</pre>
      </section>
    </div>
  </main>

  <script>
    const MAX_SIZE_BYTES = 10 * 1024 * 1024;
    const ALLOWED_TYPES = new Set(['image/png', 'image/jpeg', 'image/webp']);

    const els = {
      form: document.getElementById('uploadForm'),
      input: document.getElementById('imageInput'),
      uploadBtn: document.getElementById('uploadBtn'),
      analyzeBtn: document.getElementById('analyzeBtn'),
      preview: document.getElementById('preview'),
      noPreview: document.getElementById('noPreview'),
      status: document.getElementById('status'),
      errorText: document.getElementById('errorText'),
      output: document.getElementById('analysisOutput'),
      uploadTime: document.getElementById('uploadTime'),
      analysisTime: document.getElementById('analysisTime'),
      totalTime: document.getElementById('totalTime'),
      displayUrl: document.getElementById('displayUrl')
    };

    const state = {
      step: 'idle',
      selectedFile: null,
      displayUrl: null,
      startedAt: null,
      uploadMs: null,
      analysisMs: null
    };

    function setState(step, message, type = '') {
      state.step = step;
      els.status.textContent = `State: ${step}${message ? ` — ${message}` : ''}`;
      els.status.className = `state ${type}`.trim();
      const busy = step === 'uploading' || step === 'analyzing';
      els.uploadBtn.disabled = busy;
      els.analyzeBtn.disabled = busy || !state.displayUrl;
    }

    function setError(message) {
      els.errorText.hidden = false;
      els.errorText.textContent = message;
    }

    function clearError() {
      els.errorText.hidden = true;
      els.errorText.textContent = '';
    }

    function formatMs(ms) {
      return Number.isFinite(ms) ? `${(ms / 1000).toFixed(2)}s` : '—';
    }

    function updateMetrics() {
      els.uploadTime.textContent = formatMs(state.uploadMs);
      els.analysisTime.textContent = formatMs(state.analysisMs);
      const total = (state.uploadMs ?? 0) + (state.analysisMs ?? 0);
      els.totalTime.textContent = total ? formatMs(total) : '—';
      if (state.displayUrl) {
        els.displayUrl.innerHTML = '';
        const link = document.createElement('a');
        link.href = state.displayUrl;
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        link.textContent = state.displayUrl;
        link.style.color = '#8fb2ff';
        els.displayUrl.appendChild(link);
      } else {
        els.displayUrl.textContent = '—';
      }
    }

    function validateFile(file) {
      if (!file) {
        return 'Please select an image file.';
      }
      if (!ALLOWED_TYPES.has(file.type)) {
        return `Unsupported file type: ${file.type || 'unknown'}. Use PNG, JPG, JPEG, or WEBP.`;
      }
      if (file.size > MAX_SIZE_BYTES) {
        return `File is too large (${(file.size / 1024 / 1024).toFixed(2)}MB). Maximum is 10MB.`;
      }
      return null;
    }

    function renderPreview(file) {
      const objectUrl = URL.createObjectURL(file);
      els.preview.src = objectUrl;
      els.preview.alt = `Preview of selected image: ${file.name}`;
      els.preview.hidden = false;
      els.noPreview.hidden = true;
    }

    async function parseBackendError(response) {
      try {
        const payload = await response.json();
        return payload.error || `Request failed with status ${response.status}`;
      } catch {
        return `Request failed with status ${response.status}`;
      }
    }

    async function uploadImage(event) {
      event.preventDefault();
      clearError();

      const file = els.input.files[0];
      const validationError = validateFile(file);
      if (validationError) {
        setState('error', 'validation failed', 'error');
        setError(validationError);
        return;
      }

      renderPreview(file);
      state.selectedFile = file;
      state.displayUrl = null;
      state.analysisMs = null;
      state.uploadMs = null;
      updateMetrics();
      els.output.textContent = 'No analysis yet.';

      const formData = new FormData();
      formData.append('image', file);

      setState('uploading', 'sending file to /upload');
      const started = performance.now();

      try {
        const response = await fetch('/upload', { method: 'POST', body: formData });
        if (!response.ok) {
          throw new Error(await parseBackendError(response));
        }

        const payload = await response.json();
        if (!payload.display_url) {
          throw new Error('Backend did not return display_url.');
        }

        state.uploadMs = performance.now() - started;
        state.displayUrl = payload.display_url;

        els.preview.src = payload.display_url;
        els.preview.alt = `Uploaded image returned by server: ${file.name}`;

        updateMetrics();
        setState('success', 'image uploaded', 'success');
      } catch (err) {
        setState('error', 'upload failed', 'error');
        setError(err.message || 'Upload failed.');
      }
    }

    async function analyzeImage() {
      clearError();

      if (!state.displayUrl) {
        setState('error', 'no uploaded image', 'error');
        setError('Upload an image first before analysis.');
        return;
      }

      setState('analyzing', 'sending identifier to /analyze');
      const started = performance.now();

      try {
        const response = await fetch('/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ display_url: state.displayUrl })
        });

        if (!response.ok) {
          throw new Error(await parseBackendError(response));
        }

        const payload = await response.json();
        state.analysisMs = performance.now() - started;
        updateMetrics();

        els.output.textContent = payload.analysis_result || 'Analysis completed, but no output returned.';
        setState('success', 'analysis complete', 'success');
      } catch (err) {
        setState('error', 'analysis failed', 'error');
        setError(err.message || 'Analysis failed.');
      }
    }

    els.form.addEventListener('submit', uploadImage);
    els.analyzeBtn.addEventListener('click', analyzeImage);
    els.input.addEventListener('change', () => {
      clearError();
      const file = els.input.files[0];
      const validationError = validateFile(file);
      if (validationError) {
        setState('error', 'validation failed', 'error');
        setError(validationError);
        return;
      }
      renderPreview(file);
      setState('idle', 'file selected');
    });

    setState('idle');
  </script>
</body>
</html>
